Acquire the lock by 
```c
while (__sync_lock_test_and_set(&lock, LOCKED));
```
.

Release it by doing
```c
__sync_lock_release(&lock);
```
.